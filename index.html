<html><head><base href="https://baconsaregood.github.io/bacontube/">
<title>BaconTube</title>
<style>
:root {
  --bacon-pink: #ff9e9e;
  --bacon-brown: #8b4513;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: #f5f5f5;
}

.navbar {
  background: var(--bacon-brown);
  padding: 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: fixed;
  width: 100%;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  color: white;
  text-decoration: none;
  font-size: 1.5rem;
  font-weight: bold;
}

.logo svg {
  margin-right: 10px;
  animation: sizzle 2s infinite;
}

@keyframes sizzle {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(5deg); }
  75% { transform: rotate(-5deg); }
  100% { transform: rotate(0deg); }
}

.main-content {
  margin-top: 80px;
  padding: 20px;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}

.upload-section {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.video-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.video-card {
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}

.video-card:hover {
  transform: translateY(-5px);
}

.video-preview {
  width: 100%;
  height: 200px;
  background: #000;
  position: relative;
  overflow: hidden;
}

.video-preview video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: #000;
}

.video-preview::before {
  content: "Loading...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  display: none;
}

.video-preview.loading::before {
  display: block;
}

.video-info {
  padding: 15px;
}

.upload-btn {
  background: var(--bacon-pink);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}

.upload-btn:hover {
  background: var(--bacon-brown);
}

#upload-form {
  display: none;
  margin-top: 20px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
}

.form-group input, .form-group textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 5px;
}

.error {
  color: red;
  margin-top: 5px;
  font-size: 0.9em;
}

.success {
  color: green;
  margin-top: 5px;
  font-size: 0.9em;
}

.auth-section {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  max-width: 400px;
  width: 90%;
}

.auth-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

.auth-close {
  position: absolute;
  right: 15px;
  top: 15px;
  cursor: pointer;
  font-size: 20px;
  color: #666;
}

.auth-tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 2px solid #eee;
}

.auth-tab {
  padding: 10px 20px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.auth-tab.active {
  border-bottom-color: var(--bacon-pink);
  color: var(--bacon-brown);
}

.user-menu {
  position: relative;
  display: inline-block;
}

.user-menu-content {
  position: absolute;
  right: 0;
  top: 100%;
  background: white;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: none;
  min-width: 150px;
}

.user-menu.active .user-menu-content {
  display: block;
}

.user-menu-item {
  padding: 10px 20px;
  cursor: pointer;
  color: #333;
}

.user-menu-item:hover {
  background: #f5f5f5;
}

.user-profile {
  position: relative;
  padding: 5px 10px;
  border-radius: 5px;
}

.user-profile:hover {
  background: rgba(255,255,255,0.1);
}

.user-profile.active .user-menu-content {
  display: block;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bacon-pink);
  margin-right: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.video-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.video-action-btn {
  background: none;
  border: none;
  color: #666;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
}

.video-action-btn:hover {
  color: var(--bacon-brown);
}

.video-action-btn[onclick*="deleteVideo"] {
  margin-left: auto; /* Push delete button to the right */
  color: #ff4444;
}

.video-action-btn[onclick*="deleteVideo"]:hover {
  color: #cc0000;
}

/* Add a subtle animation when removing videos */
.video-card.removing {
  animation: fadeOut 0.3s ease-out forwards;
}

@keyframes fadeOut {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.9);
  }
}

/* Add custom video controls styling */
video::-webkit-media-controls {
  background-color: rgba(0, 0, 0, 0.5);
}

video::-webkit-media-controls-panel {
  display: flex !important;
  opacity: 1 !important;
}

.user-menu-content {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  min-width: 150px;
  display: none;
  margin-top: 5px;
}

.user-menu-content:before {
  content: '';
  position: absolute;
  top: -5px;
  right: 20px;
  width: 10px;
  height: 10px;
  background: white;
  transform: rotate(45deg);
}

.admin-avatar {
  background: linear-gradient(45deg, var(--bacon-brown), var(--bacon-pink)) !important;
  border: 2px solid gold;
}

.user-profile .admin-badge {
  color: gold;
  margin-left: 5px;
}

.admin-stats {
  background: #f5f5f5;
  padding: 20px;
  border-radius: 5px;
  margin-top: 10px;
}

.admin-stats div {
  margin: 10px 0;
  font-size: 1.1em;
}

.admin-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}
</style>
</head>
<body>
  <nav class="navbar">
    <a href="https://baconsaregood.github.io/bacontube/" class="logo">
      <svg width="30" height="30" viewBox="0 0 100 100">
        <path d="M20,30 Q40,20 60,30 T100,30" fill="none" stroke="var(--bacon-pink)" stroke-width="10"/>
        <path d="M20,50 Q40,40 60,50 T100,50" fill="none" stroke="var(--bacon-pink)" stroke-width="10"/>
        <path d="M20,70 Q40,60 60,70 T100,70" fill="none" stroke="var(--bacon-pink)" stroke-width="10"/>
      </svg>
      BaconTube
    </a>
    <div class="nav-controls">
      <button class="upload-btn" onclick="checkAuthAndUpload()" style="margin-right: 10px;">Upload Video</button>
      <div id="auth-controls">
        <button class="upload-btn" onclick="showAuth()">Login / Sign Up</button>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <section class="upload-section">
      <form id="upload-form">
        <div class="form-group">
          <label for="video-file">Choose Video File</label>
          <input type="file" id="video-file" accept="video/*" required>
          <div id="file-error" class="error"></div>
        </div>
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" required>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="tags">Tags (comma separated)</label>
          <input type="text" id="tags" placeholder="a, b, c">
        </div>
        <button type="submit" class="upload-btn">Post Video</button>
        <div id="upload-status"></div>
      </form>
    </section>

    <section class="video-grid" id="videos">
      <!-- Video cards will be dynamically added here -->
    </section>
  </main>

  <!-- Auth Modal -->
  <div id="auth-modal" style="display: none;">
    <div class="auth-backdrop"></div>
    <div class="auth-section">
      <span class="auth-close" onclick="hideAuth()">√ó</span>
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
        <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
      </div>
      <form id="login-form">
        <div class="form-group">
          <label for="login-username">Username</label>
          <input type="text" id="login-username" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" required>
        </div>
        <button type="submit" class="upload-btn">Login</button>
        <div id="login-status" class="error"></div>
      </form>
      <form id="signup-form" style="display: none;">
        <div class="form-group">
          <label for="signup-username">Username</label>
          <input type="text" id="signup-username" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" required>
        </div>
        <div class="form-group">
          <label for="signup-confirm">Confirm Password</label>
          <input type="password" id="signup-confirm" required>
        </div>
        <button type="submit" class="upload-btn">Sign Up</button>
        <div id="signup-status" class="error"></div>
      </form>
    </div>
  </div>

<script>
// Initialize IndexedDB
let db;
const dbName = "BaconTubeDB";
const request = indexedDB.open(dbName, 2);

request.onerror = (event) => {
  console.error("Database error: " + event.target.error);
};

request.onupgradeneeded = (event) => {
  db = event.target.result;
  
  if (!db.objectStoreNames.contains('videos')) {
    const videoStore = db.createObjectStore('videos', { keyPath: 'id', autoIncrement: true });
    videoStore.createIndex('timestamp', 'timestamp', { unique: false });
    videoStore.createIndex('userId', 'userId', { unique: false });
  }
  
  if (!db.objectStoreNames.contains('users')) {
    const userStore = db.createObjectStore('users', { keyPath: 'username' });
    userStore.createIndex('username', 'username', { unique: true });
  }
};

// Admin config
const ADMIN_CONFIG = {
  username: 'bacon',
  password: '05110511',
  allowedIP: '185.108.105.82'
};

// Add this function to check IP address
async function getCurrentIP() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;
  } catch (error) {
    console.error('Error getting IP:', error);
    return null;
  }
}

request.onsuccess = (event) => {
  db = event.target.result;
  loadVideos();
  checkAuthStatus();
};

let currentUser = null;

function showAuth() {
  document.getElementById('auth-modal').style.display = 'block';
}

function hideAuth() {
  document.getElementById('auth-modal').style.display = 'none';
}

function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  if (tab === 'login') {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('signup-form').style.display = 'none';
  } else {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'block';
  }
}

document.getElementById('login-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  
  try {
    const user = await loginUser(username, password);
    currentUser = user;
    hideAuth();
    updateAuthUI();
    this.reset();
  } catch (error) {
    document.getElementById('login-status').textContent = error.message;
  }
});

document.getElementById('signup-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const username = document.getElementById('signup-username').value;
  const password = document.getElementById('signup-password').value;
  const confirm = document.getElementById('signup-confirm').value;
  
  if (password !== confirm) {
    document.getElementById('signup-status').textContent = "Passwords don't match";
    return;
  }
  
  try {
    await createUser(username, password);
    const user = await loginUser(username, password);
    currentUser = user;
    hideAuth();
    updateAuthUI();
    this.reset();
  } catch (error) {
    document.getElementById('signup-status').textContent = error.message;
  }
});

function checkAuthStatus() {
  const storedUser = localStorage.getItem('currentUser');
  if (storedUser) {
    try {
      currentUser = JSON.parse(storedUser);
      updateAuthUI();
    } catch (e) {
      localStorage.removeItem('currentUser');
      currentUser = null;
    }
  }
}

async function createUser(username, password) {
  return new Promise((resolve, reject) => {
    // Prevent creation of admin username
    if (username.toLowerCase() === ADMIN_CONFIG.username) {
      reject(new Error('This username is reserved'));
      return;
    }

    const transaction = db.transaction(['users'], 'readwrite');
    const store = transaction.objectStore('users');
    
    const getRequest = store.get(username);
    
    getRequest.onsuccess = () => {
      if (getRequest.result) {
        reject(new Error('Username already exists'));
        return;
      }
      
      const user = {
        username,
        password,
        isAdmin: false,
        joinDate: new Date().getTime()
      };
      
      const addRequest = store.add(user);
      
      addRequest.onsuccess = () => resolve(user);
      addRequest.onerror = () => reject(new Error('Error creating user'));
    };
  });
}

async function loginUser(username, password) {
  return new Promise(async (resolve, reject) => {
    // Check if trying to login as admin
    if (username.toLowerCase() === ADMIN_CONFIG.username) {
      // Verify IP for admin account
      const currentIP = await getCurrentIP();
      if (currentIP !== ADMIN_CONFIG.allowedIP) {
        reject(new Error('Unauthorized IP address for admin account'));
        return;
      }
      
      // Verify admin password
      if (password !== ADMIN_CONFIG.password) {
        reject(new Error('Invalid admin password'));
        return;
      }

      // Create admin user object
      const adminUser = {
        username: ADMIN_CONFIG.username,
        isAdmin: true,
        joinDate: new Date().getTime()
      };
      
      localStorage.setItem('currentUser', JSON.stringify(adminUser));
      resolve(adminUser);
      return;
    }

    // Regular user login proceeds as before
    const transaction = db.transaction(['users'], 'readonly');
    const store = transaction.objectStore('users');
    
    const request = store.get(username);
    
    request.onsuccess = () => {
      const user = request.result;
      if (!user) {
        reject(new Error('User not found'));
        return;
      }
      
      if (user.password === password) {
        user.isAdmin = false; // Ensure regular users don't get admin powers
        localStorage.setItem('currentUser', JSON.stringify(user));
        resolve(user);
      } else {
        reject(new Error('Invalid password'));
      }
    };
    
    request.onerror = () => reject(new Error('Login failed'));
  });
}

function logout() {
  currentUser = null;
  localStorage.removeItem('currentUser');
  updateAuthUI();
}

function updateAuthUI() {
  const authControls = document.getElementById('auth-controls');
  
  if (currentUser) {
    authControls.innerHTML = `
      <div class="user-profile" onclick="toggleUserMenu()">
        <div class="user-avatar ${currentUser.isAdmin ? 'admin-avatar' : ''}">${currentUser.username[0].toUpperCase()}</div>
        <span>${currentUser.username}${currentUser.isAdmin ? ' üëë' : ''}</span>
        <div class="user-menu-content">
          ${currentUser.isAdmin ? '<div class="user-menu-item" onclick="showAdminPanel()">Admin Panel</div>' : ''}
          <div class="user-menu-item" onclick="logout()">Logout</div>
        </div>
      </div>
    `;
  } else {
    authControls.innerHTML = `
      <button class="upload-btn" onclick="showAuth()">Login / Sign Up</button>
    `;
  }
}

function checkAuthAndUpload() {
  if (!currentUser) {
    showAuth();
    return;
  }
  toggleUpload();
}

function toggleUpload() {
  const uploadForm = document.getElementById('upload-form');
  if (uploadForm.style.display === 'none' || !uploadForm.style.display) {
    uploadForm.style.display = 'block';
  } else {
    uploadForm.style.display = 'none';
    // Reset form when hiding
    uploadForm.reset();
    document.getElementById('upload-status').innerHTML = '';
    document.getElementById('file-error').innerHTML = '';
  }
}

function createVideoCard(video) {
  const card = document.createElement('div');
  card.className = 'video-card';
  
  // Add data attribute for video ID
  card.setAttribute('data-video-id', video.id);
  
  card.innerHTML = `
    <div class="video-preview">
      <video src="${video.videoUrl}" 
             controls
             preload="metadata"
             controlsList="nodownload" 
             poster="${video.thumbnailUrl || ''}"
             onplay="incrementViews(${video.id})"
             class="video-player">
        Your browser does not support the video tag.
      </video>
    </div>
    <div class="video-info">
      <h3>${video.title}</h3>
      <p>By ${video.author}</p>
      <small>${video.views || 0} views ‚Ä¢ ${formatTimestamp(video.timestamp)}</small>
      <div class="video-actions">
        <button class="video-action-btn" onclick="likeVideo(${video.id})">
          <span>üëç ${video.likes || 0}</span>
        </button>
        <button class="video-action-btn" onclick="shareVideo(${video.id})">
          <span>Share</span>
        </button>
        ${currentUser && currentUser.isAdmin ? `
          <button class="video-action-btn" onclick="deleteVideo(${video.id})" style="color: red;">
            <span>üóëÔ∏è Delete</span>
          </button>
        ` : ''}
      </div>
    </div>
  `;
  return card;
}

// New function to track video views
async function incrementViews(videoId) {
  if (!db) return;
  
  const transaction = db.transaction(['videos'], 'readwrite');
  const store = transaction.objectStore('videos');
  
  try {
    const videoData = await new Promise((resolve, reject) => {
      const request = store.get(videoId);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
    
    videoData.views = (videoData.views || 0) + 1;
    
    await new Promise((resolve, reject) => {
      const updateRequest = store.put(videoData);
      updateRequest.onsuccess = () => resolve();
      updateRequest.onerror = () => reject(updateRequest.error);
    });
  } catch (error) {
    console.error('Error incrementing views:', error);
  }
}

async function deleteVideo(videoId) {
  if (!currentUser || !currentUser.isAdmin) {
    alert('Only administrators can delete videos');
    return;
  }

  if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
    return;
  }

  const transaction = db.transaction(['videos'], 'readwrite');
  const store = transaction.objectStore('videos');
  
  try {
    // Delete the video
    await new Promise((resolve, reject) => {
      const request = store.delete(videoId);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });

    // Reload videos to show updated state
    await loadVideos();
    
    // Show success message
    alert('Video successfully deleted');
    
  } catch (error) {
    console.error('Error deleting video:', error);
    alert('Failed to delete video: ' + error.message);
  }
}

function formatTimestamp(timestamp) {
  const now = new Date();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (days > 0) return `${days} days ago`;
  if (hours > 0) return `${hours} hours ago`;
  if (minutes > 0) return `${minutes} minutes ago`;
  return 'Just now';
}

async function loadVideos() {
  const videoGrid = document.getElementById('videos');
  videoGrid.innerHTML = '';

  const transaction = db.transaction(['videos'], 'readonly');
  const store = transaction.objectStore('videos');
  const index = store.index('timestamp');

  const request = index.openCursor(null, 'prev');
  
  request.onsuccess = (event) => {
    const cursor = event.target.result;
    if (cursor) {
      videoGrid.appendChild(createVideoCard(cursor.value));
      cursor.continue();
    }
  };
}

document.getElementById('upload-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (!currentUser) {
    alert('Please login to upload videos');
    return;
  }

  const fileInput = document.getElementById('video-file');
  const title = document.getElementById('title').value;
  const description = document.getElementById('description').value;
  const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim());
  const statusDiv = document.getElementById('upload-status');
  const fileError = document.getElementById('file-error');

  if (!fileInput.files[0]) {
    fileError.textContent = 'Please select a video file';
    return;
  }
  
  if (!fileInput.files[0].type.startsWith('video/')) {
    fileError.textContent = 'Please select a valid video file';
    return;
  }

  statusDiv.innerHTML = '<div class="success">Uploading video...</div>';

  try {
    const videoUrl = await readFileAsDataURL(fileInput.files[0]);
    
    const video = {
      title: title,
      description: description,
      author: currentUser.username,
      userId: currentUser.username,
      views: 0,
      likes: 0,
      timestamp: new Date().getTime(),
      videoUrl: videoUrl,
      thumbnailUrl: '', // Placeholder for future thumbnail support
      tags: tags
    };

    const transaction = db.transaction(['videos'], 'readwrite');
    const store = transaction.objectStore('videos');
    await store.add(video);

    statusDiv.innerHTML = '<div class="success">Video uploaded successfully!</div>';
    this.reset();
    toggleUpload();
    loadVideos();
  } catch (error) {
    statusDiv.innerHTML = `<div class="error">Error uploading video: ${error.message}</div>`;
  }
});

async function likeVideo(videoId) {
  if (!currentUser) {
    showAuth();
    return;
  }

  const transaction = db.transaction(['videos'], 'readwrite');
  const store = transaction.objectStore('videos');
  
  try {
    // Get the video data properly using a Promise
    const video = await new Promise((resolve, reject) => {
      const request = store.get(videoId);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
    
    if (!video) {
      throw new Error('Video not found');
    }

    // Update likes count
    video.likes = (video.likes || 0) + 1;
    
    // Put the updated video back in the store
    await new Promise((resolve, reject) => {
      const putRequest = store.put(video);
      putRequest.onsuccess = () => resolve();
      putRequest.onerror = () => reject(putRequest.error);
    });

    // Reload videos to show updated like count
    await loadVideos();
    
  } catch (error) {
    console.error('Error liking video:', error);
  }
}

function shareVideo(videoId) {
  alert('Sharing functionality would be implemented here!');
}

function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsDataURL(file);
  });
}

// New function to show admin panel
function showAdminPanel() {
  if (!currentUser || !currentUser.isAdmin) {
    alert('Access denied');
    return;
  }

  const adminPanelHTML = `
    <div class="auth-backdrop"></div>
    <div class="auth-section" style="max-width: 800px;">
      <span class="auth-close" onclick="hideAdminPanel()">√ó</span>
      <h2 style="margin-bottom: 20px;">Admin Panel</h2>
      <div class="admin-stats">
        <div id="total-videos">Loading stats...</div>
        <div id="total-users">Loading stats...</div>
      </div>
      <div class="admin-actions" style="margin-top: 20px;">
        <button class="upload-btn" onclick="refreshStats()">Refresh Stats</button>
      </div>
    </div>
  `;

  const adminPanel = document.createElement('div');
  adminPanel.id = 'admin-panel';
  adminPanel.style.position = 'fixed';
  adminPanel.style.top = '0';
  adminPanel.style.left = '0';
  adminPanel.style.right = '0';
  adminPanel.style.bottom = '0';
  adminPanel.style.zIndex = '1000';
  adminPanel.innerHTML = adminPanelHTML;

  document.body.appendChild(adminPanel);
  refreshStats();
}

// Function to hide admin panel
function hideAdminPanel() {
  const adminPanel = document.getElementById('admin-panel');
  if (adminPanel) {
    adminPanel.remove();
  }
}

// Function to refresh admin stats
async function refreshStats() {
  if (!currentUser || !currentUser.isAdmin) return;

  const videosTxn = db.transaction(['videos'], 'readonly');
  const usersTxn = db.transaction(['users'], 'readonly');
  
  const videoStore = videosTxn.objectStore('videos');
  const userStore = usersTxn.objectStore('users');

  try {
    // Count videos
    const videoCount = await new Promise((resolve, reject) => {
      const request = videoStore.count();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    // Count users
    const userCount = await new Promise((resolve, reject) => {
      const request = userStore.count();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    // Update stats display
    document.getElementById('total-videos').textContent = `Total Videos: ${videoCount}`;
    document.getElementById('total-users').textContent = `Total Users: ${userCount}`;

  } catch (error) {
    console.error('Error refreshing stats:', error);
  }
}

// Initialize everything
window.addEventListener('load', () => {
  if (!window.indexedDB) {
    console.error("Your browser doesn't support IndexedDB");
    alert("Your browser doesn't support storing videos. Please use a modern browser.");
  }
});

// New function to toggle user menu
function toggleUserMenu() {
  const userProfile = event.currentTarget;
  const wasActive = userProfile.classList.contains('active');
  
  // Close any open menus first
  document.querySelectorAll('.user-profile').forEach(menu => {
    menu.classList.remove('active');
  });
  
  // Toggle the clicked menu
  if (!wasActive) {
    userProfile.classList.add('active');
  }
  
  // Close menu when clicking outside
  function closeMenu(e) {
    if (!userProfile.contains(e.target)) {
      userProfile.classList.remove('active');
      document.removeEventListener('click', closeMenu);
    }
  }
  
  if (!wasActive) {
    // Small delay to prevent immediate closing
    setTimeout(() => {
      document.addEventListener('click', closeMenu);
    }, 0);
  }
}
</script>
</body></html>